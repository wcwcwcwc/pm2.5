<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>数据查询</title>
	<link rel="stylesheet" href="/static/css/ol.css" type="text/css"> 
	<link rel="stylesheet" type="text/css" href="/static/css/query.css">
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.css">
	<style type="text/css">

	</style>
</head>
<body>
	<nav class="navbar navbar-default">
    	<ul class="nav navbar-nav">
    		<li><a href="javascript:">band</a></li>
        	<li ><a href="/">首页</a></li>
        	<li class="active"><a href="/query">数据查询<span class="sr-only">(current)</span></a></li>
        	<li ><a href="/an">数据分析</a></li>
        </ul>
      	<div class="navbar-form navbar-left">
	        <div class="form-group">
	          <input type="text" class="form-control" placeholder="请输入城市">
	        </div>
	        <div class="form-group">
	          <input type="text" class="form-control" placeholder="请输入时间">
	        </div>
        	<button  class="btn btn-default">搜索</button>
        </div>
	</nav>
	<!-- popup -->
	<div id="ol-popup" class="ol-popup">
		<div class="popup-top">
			<ul class="popup-ul">
				<li ><span id='cityName'>{{city}}</span></li>
				<a id="change" href="#"><li>变化趋势</li></a>
				<li>...</li>
			</ul>
			<a href="#" id="popup-closer" class="ol-popup-closer"></a> 
		</div>
	    <div id="popup-content"  class="popup-content">
	    	<div class="time-content">{{}}</div>
	    	<span class="circle" id="aqi-data" >{{aqi}}</span>
	    	<span class="circle"  id="pm25-data">{{pm25}}</span>
	    	<span class="circle" id="rank">{}</span>
	    	<div>
	    		<span class="popup-text">AQI</span>
	    		<span class="popup-text">pm2.5</span>
	    		<span class="popup-text">排名</span>
	    	</div>
	    </div>
	</div>  
	<div class="map" id="map">
	</div>
	<div id="echart" class='echart'>
	</div>
	<script type="text/javascript" src="/static/script/vue.js"></script>
	<script type="text/javascript" src="/static/script/zepto.js"></script>
	<script src="/static/script/ol.js" type="text/javascript"></script> 
	<script type="text/javascript" src="/static/script/pages/main.js"></script>
	<script type="text/javascript" src="/static/script/echarts.min.js"></script>
	<script type="text/javascript" src="/static/script/pages/queryfuc.js"></script>
	<script>
		var map;
		var shandong;
		var container = document.getElementById('ol-popup');
		var vm=new Vue({
				el:'#ol-popup',
				data:{
					city:[],
					aqi:[],
					pm25:[]
				},
				methods:{
					getData:function(cityname){
						var _this=this;
						$.get('/ajax/query',function(d){
							for(var i=0;i<d.length;i++){
								if(d[i].city==cityname){
									_this.city=d[i].city;
									_this.aqi=d[i].aqi;
									_this.pm25=d[i].pm25;
								}
							}
						},'json')
					}
				}
			});
		var overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({  
		  element: container,  
		  autoPan: true,  
		  autoPanAnimation: {  
		  duration: 250   //当Popup超出地图边界时，为了Popup全部可见，地图移动的速度.   
		  }  
		}));

		var shandongData=[{name:'烟台',lon:120.7397,lat:37.5128},{name:'临沂',lon:118.3118,lat:35.2906},{name:'潍坊',lon:119.0918,lat:36.524},{name:'青岛',lon:120.4651,lat:36.3373},{name:'菏泽',lon:115.6201,lat:35.2057},{name:'济宁',lon:116.8286,lat:35.3375},{name:'德州',lon:116.6858,lat:37.2107},{name:'滨州',lon:117.8174,lat:37.4963},{name:'聊城',lon:115.9167,lat:36.4032},{name:'东营',lon:118.7073,lat:37.5513},{name:'济南',lon:117.1582,lat:36.8701},{name:'泰安',lon:117.0264,lat:36.0516},{name:'威海',lon:121.9482,lat:37.1393},{name:'日照',lon:119.2786,lat:35.5023},{name:'淄博',lon:118.0371,lat:36.6064},{name:'枣庄',lon:117.323,lat:34.8926},{name:'莱芜',lon:117.6526,lat:36.2714}];
		
		var mapFunc={
			initmap:function(){
				/** 
				 * 定义矢量图层 
				 * 其中style是矢量图层的显示样式  
				 */ 
				var style = new ol.style.Style({  
				  /*fill: new ol.style.Fill({ //矢量图层填充颜色，以及透明度  
				    color: 'rgba(255, 255, 255, 0.1)'  
				  }), */ 
				  stroke: new ol.style.Stroke({ //边界样式  
				    color: '#319FD3',  
			    	width: 3   
				  }),  
				  text: new ol.style.Text({ //文本样式  
				    font: '12px Calibri,sans-serif',  
				    fill: new ol.style.Fill({  
				      color: '#000'  
				    }),  
				    stroke: new ol.style.Stroke({  
				      color: '#fff',  
				      width: 3  
				    })  
				  })  
				});
			   	shandong = new ol.layer.Vector({ //初始化矢量图层  
				  source: new ol.source.Vector({  
				    projection: 'EPSG:3857',  
				    url: 'http://localhost:3001/ajax/shandong',  //从文件加载边界等地理信息  
				    format:new ol.format.GeoJSON()
				  }),  
				  style: function(feature, resolution) {  
				    return [style];  
				  }  
				});  
			    //初始化地图容器
			    map = new ol.Map({
			        layers: [
			        	new ol.layer.Tile({
						    source: new ol.source.OSM()
						  }),layer,shandong],
			        target: 'map', //地图容器div的ID
			        view: new ol.View({
			            projection: 'EPSG:3857',  //投影坐标系
			             center: ol.proj.transform([118,36.4], 'EPSG:4326', 'EPSG:3857'), 
			            minZoom: 5,
			            zoom:7
			        })
	    		});
			}
		}
		mapFunc.initmap();
		addPopup(shandongData,15);  
		map.on('click',function(evt){
			var pixel = map.getEventPixel(evt.originalEvent); 
			var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {  
				return feature;  
			});
			var cityname=feature.get('name').replace('市','');
			//alert(cityname);
			var coordinate = evt.coordinate;  
			overlay.setPosition(coordinate); 
			map.addOverlay(overlay);
			$('#ol-popup').css('display','block');
			vm.getData(cityname);
		})
	</script>
</body>
</html>